---
# Main VM Configuration Playbook
- name: Main VM Configuration (Security & Basic Setup)
  hosts: all
  become: true

  vars:
    new_user: devopsadmin
    new_user_password: "{{ 'SecureAdminPassword123!' | password_hash('sha512') }}"
    timezone: "Africa/Casablanca"

  tasks:
    ###########################################################################
    # SYSTEM UPDATES & MAINTENANCE
    ###########################################################################
    
    - name: Update package cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist

    ###########################################################################
    # TIMEZONE CONFIGURATION
    ###########################################################################
    
    - name: Set system timezone
      timezone:
        name: "{{ timezone }}"

    ###########################################################################
    # ESSENTIAL TOOLS INSTALLATION
    ###########################################################################
    
    - name: Install essential packages
      apt:
        name:
          - vim
          - curl
          - git
          - htop
          - ufw
        state: present

    ###########################################################################
    # USER MANAGEMENT
    ###########################################################################
    
    - name: Create sudo user "{{ new_user }}"
      user:
        name: "{{ new_user }}"
        password: "{{ new_user_password }}"
        groups: sudo
        shell: /bin/bash
        create_home: yes

    ###########################################################################
    # FIREWALL CONFIGURATION
    ###########################################################################
    
    - name: Allow SSH through firewall
      ufw:
        rule: allow
        name: OpenSSH

    - name: Enable UFW firewall
      ufw:
        state: enabled
        policy: deny