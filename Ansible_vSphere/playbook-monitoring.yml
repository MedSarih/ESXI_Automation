
# ==============================
# Monitoring Server Playbook
# ==============================
- name: Setup Monitoring Server (Prometheus & Grafana)
  hosts: monitoring_servers
  become: true
  vars:
    prometheus_port: 9090
    grafana_port: 3000
    monitoring_data_dir: /opt/monitoring
    grafana_admin_password: "{{ grafana_admin_password | default('SecureMonitoring123!') }}"
    new_user: template
  tasks:
    - name: Ensure monitoring directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: '0755'
      loop:
        - "{{ monitoring_data_dir }}/prometheus"
        - "{{ monitoring_data_dir }}/grafana"

    - name: Pull Prometheus and Grafana images
      ansible.builtin.shell: |
        docker pull prom/prometheus:v2.45.0
        docker pull grafana/grafana:9.5.6

    - name: Create Prometheus configuration
      ansible.builtin.copy:
        content: |
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
        dest: "{{ monitoring_data_dir }}/prometheus/prometheus.yml"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: '0644'

    - name: Run Prometheus container
      ansible.builtin.shell: |
        docker rm -f prometheus || true
        docker run -d --name prometheus \
          -p {{ prometheus_port }}:9090 \
          -v {{ monitoring_data_dir }}/prometheus:/prometheus \
          -v {{ monitoring_data_dir }}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro \
          prom/prometheus:v2.45.0 \
          --config.file=/etc/prometheus/prometheus.yml \
          --storage.tsdb.path=/prometheus \
          --web.enable-lifecycle

    - name: Run Grafana container
      ansible.builtin.shell: |
        docker rm -f grafana || true
        docker run -d --name grafana \
          -p {{ grafana_port }}:3000 \
          -v {{ monitoring_data_dir }}/grafana:/var/lib/grafana \
          -e GF_SECURITY_ADMIN_USER=admin \
          -e GF_SECURITY_ADMIN_PASSWORD="{{ grafana_admin_password }}" \
          -e GF_USERS_ALLOW_SIGN_UP=false \
          grafana/grafana:9.5.6

    - name: Allow Prometheus and Grafana ports through firewall
      ansible.builtin.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"